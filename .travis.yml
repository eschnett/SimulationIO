# General settings
notifications:
  email: false
sudo: false

# Build matrix
os:
  - linux   # This is currently Ubuntu 12.04 LTS
  - osx
language: cpp
compiler:
  - clang
  - gcc
matrix:
  exclude:
    - os: osx
      compiler: gcc

# Install, buuild, and test
addons:
  apt:
    packages:
      - lcov
      # - libhdf5-serial-dev   # This lacks the HDF5 C++ bindings
      - libopenmpi-dev
      - openmpi-bin
      - python-numpy
      - swig
before_install:
  - |
    if [ `uname` = Darwin ]; then
      brew update
      brew install homebrew/science/hdf5
      brew install lcov
      brew install open-mpi
      brew install python
      brew install swig
      export HDF5_DIR="/usr/local"
      export PYTHON_DIR="/usr/local"
    fi
  - |
    if [ `uname` = Linux ]; then
      export HDF5_DIR="$HOME/hdf5-1.10.0-patch1"
      (
        mkdir external
        cd external
        wget https://www.hdfgroup.org/ftp/HDF5/releases/hdf5-1.10/hdf5-1.10.0-patch1/src/hdf5-1.10.0-patch1.tar.bz2
        tar xjf hdf5-1.10.0-patch1.tar.bz2
        mkdir hdf5-1.10.0-patch1-build
        cd hdf5-1.10.0-patch1-build
        `pwd`/../hdf5-1.10.0-patch1/configure --prefix="$HDF5_DIR" --enable-cxx
        make -j2
        make -j2 install
      )
      export PYTHON_DIR="/usr"
    fi
  - export PATH="$HDF5_DIR/bin:$PYTHON_DIR/bin:$PATH"
  - pip install --user h5py
  - pip install --user codecov
  - gem install coveralls-lcov
  - which $CXX
  - which python
  - which h5ls
  - which mpirun
  - which lcov
  - $CXX --version
  - python --version
  - h5ls --version
  - mpirun --version
  - lcov --version
script:
  - make -j2 COVERAGE=1 CXX="$CXX" HDF5_DIR="$HDF5_DIR" PYTHON_DIR="$PYTHON_DIR"
  - make -j2 check
after_success:
  - make -j2 coverage
  - codecov
  - coveralls-lcov coverage.info
