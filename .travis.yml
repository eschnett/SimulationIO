# General settings
notifications:
  email: false
sudo: false

# Build matrix
os:
  - linux                       # This is currently Ubuntu 12.04 LTS
  - osx
language: cpp
compiler:
  - clang
  - gcc
matrix:
  exclude:
    - os: osx
      compiler: gcc

# Install, build, and test
addons:
  apt:
    packages:
      - lcov
      - libopenmpi-dev
      - openmpi-bin
      - python-numpy
      - swig
cache:
  directories:
    - $HOME/hdf5-1.10.0-patch1
install:
  - which $CXX
  - $CXX --version
  - which mpirun
  - mpirun --version
  - |
    if [ "$TRAVIS_OS_NAME" = linux ]; then
      export HDF5_DIR="$HOME/hdf5-1.10.0-patch1"
      # Check cache
      if [ ! -d "$HDF5_DIR" ]; then
        (
          mkdir external
          cd external
          wget https://www.hdfgroup.org/ftp/HDF5/releases/hdf5-1.10/hdf5-1.10.0-patch1/src/hdf5-1.10.0-patch1.tar.bz2
          tar xjf hdf5-1.10.0-patch1.tar.bz2
          mkdir hdf5-1.10.0-patch1-build
          cd hdf5-1.10.0-patch1-build
          `pwd`/../hdf5-1.10.0-patch1/configure --prefix="$HDF5_DIR" --enable-cxx
          make -j2
          make -j2 install
        )
      fi
      export PYTHON_DIR="/usr"
    fi
  - |
    if [ "$TRAVIS_OS_NAME" = osx ]; then
      brew update
      brew install homebrew/science/hdf5
      brew install lcov
      brew install open-mpi
      brew install python
      brew install swig
      export HDF5_DIR="/usr/local"
      export PYTHON_DIR="/usr/local/Cellar/python/2.7.12_1/Frameworks/Python.framework/Versions/2.7"
    fi
  - export PATH="$HDF5_DIR/bin:$PYTHON_DIR/bin:$PATH" && hash -r
  - which h5ls
  - h5ls --version
  - which python
  - python --version
  - pip install --user h5py
  - pip install --user codecov
  - gem install coveralls-lcov
  - which lcov
  - lcov --version
script:
  - mkdir build && pushd build
  - cmake -DCMAKE_FIND_ROOT_PATH="$HDF5_DIR;$PYTHON_DIR" -DCMAKE_CXX_COMPILER="$CXX" -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX="$HOME/install" ..
  - make -j2
  - make -j2 test CTEST_OUTPUT_ON_FAILURE=1
  - make -j2 install
  - popd
after_success:
  - mkdir -p "$HOME/bin" && ln -s "$(which $GCOV)" "$HOME/bin/gcov" && ls -l "$HOME/bin" && export PATH="$HOME/bin:$PATH" && hash -r
  - mkdir build-coveralls && pushd build-coveralls
  - cmake -DCMAKE_FIND_ROOT_PATH="$HDF5_DIR;$PYTHON_DIR" -DCMAKE_CXX_COMPILER="$CXX" -DCMAKE_BUILD_TYPE=Debug -DCOVERALLS=ON ..
  - make -j2
  - make -j2 coveralls CTEST_OUTPUT_ON_FAILURE=1
  - popd
